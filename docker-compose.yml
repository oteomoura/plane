version: "3.8"

services:
  db:
    image: postgres:16
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-plane}
      POSTGRES_USER: ${POSTGRES_USER:-plane}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-plane_password}
    volumes:
      - plane_db:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:7
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - plane_redis:/data
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:3-management
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-plane}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-plane_password}
    volumes:
      - plane_rabbitmq:/var/lib/rabbitmq
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-plane}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-plane_password}
    volumes:
      - plane_minio:/data
    restart: unless-stopped

  api:
    image: artifacts.plane.so/makeplane/plane-backend:${APP_RELEASE:-v1.0.0}
    command: ./bin/docker-entrypoint-api.sh
    depends_on: [db, redis, rabbitmq, minio]
    env_file: [.env]
    restart: unless-stopped

  worker:
    image: artifacts.plane.so/makeplane/plane-backend:${APP_RELEASE:-v1.0.0}
    command: ./bin/docker-entrypoint-worker.sh
    depends_on: [api]
    env_file: [.env]
    restart: unless-stopped

  beat:
    image: artifacts.plane.so/makeplane/plane-backend:${APP_RELEASE:-v1.0.0}
    command: ./bin/docker-entrypoint-beat.sh
    depends_on: [api]
    env_file: [.env]
    restart: unless-stopped

  live:
    image: artifacts.plane.so/makeplane/plane-live:${APP_RELEASE:-v1.0.0}
    depends_on: [api, redis]
    env_file: [.env]
    restart: unless-stopped

  web:
    image: artifacts.plane.so/makeplane/plane-frontend:${APP_RELEASE:-v1.0.0}
    depends_on: [api, live]
    env_file: [.env]
    restart: unless-stopped

  # âœ… Only this one gets exposed to the internet via Traefik
  plane-proxy:
    image: artifacts.plane.so/makeplane/plane-proxy:${APP_RELEASE:-v1.0.0}
    depends_on: [web, api, live]
    environment:
      - SERVICE_URL_PLANE
      - "APP_DOMAIN=${SERVICE_URL_PLANE}"
      - "SITE_ADDRESS=:80"
      - "FILE_SIZE_LIMIT=${FILE_SIZE_LIMIT:-5242880}"
      - "BUCKET_NAME=${AWS_STORAGE_BUCKET_NAME:-uploads}"
    restart: unless-stopped
    networks:
      - default
      - coolify
    labels:
      - "traefik.enable=true"

      # HTTP -> HTTPS
      - "traefik.http.routers.plane-http.rule=Host(`${PLANE_DOMAIN}`)"
      - "traefik.http.routers.plane-http.entrypoints=http"
      - "traefik.http.routers.plane-http.middlewares=plane-https-redirect"
      - "traefik.http.middlewares.plane-https-redirect.redirectscheme.scheme=https"

      # HTTPS router
      - "traefik.http.routers.plane.rule=Host(`${PLANE_DOMAIN}`)"
      - "traefik.http.routers.plane.entrypoints=https"
      - "traefik.http.routers.plane.tls=true"
      - "traefik.http.routers.plane.tls.certresolver=letsencrypt"
      - "traefik.http.services.plane.loadbalancer.server.port=80"

volumes:
  plane_db:
  plane_redis:
  plane_rabbitmq:
  plane_minio:

networks:
  coolify:
    external: true